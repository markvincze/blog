<!DOCTYPE html>
<html lang="en">

<head>
  
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-72523215-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag() { dataLayer.push(arguments); }
    gtag('js', new Date());
    gtag('config', 'UA-72523215-1');
  </script>

  <title>Back to basics: Dictionary part 4, custom GetHashCode</title>

  <link rel="stylesheet" href="/styles/styles.css">
  
  <script src="https://kit.fontawesome.com/9b3bcefedf.js" crossorigin="anonymous"></script>
  <script defer src="/scripts/scripts.js"></script>
  <script defer src="https://cdn.jsdelivr.net/npm/cookieconsent@3/build/cookieconsent.min.js" data-cfasync="false"></script>
  <link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/cookieconsent@3/build/cookieconsent.min.css" />

  <link rel="stylesheet" href="/scripts/dimbox/dimbox.min.css" />
  <script src="/scripts/dimbox/dimbox.min.js"></script>

  <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
  <link rel="manifest" href="/site.webmanifest">

  <meta charset="utf-8">

  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="description" content="" />

  <meta property="og:url" content="https://blog.markvincze.com/back-to-basics-dictionary-part-4-custom-gethashcode/" />
  <meta property="og:type" content="article" />
  <meta property="og:title" content="Back to basics: Dictionary part 4, custom GetHashCode" />
  <meta property="og:description" content="" />
  <meta property="og:site_name" content="Mark Vincze" />
  

  <meta name="twitter:card" content="summary" />
  <meta name="twitter:site" content="@mrkvincze" />
  <meta name="twitter:title" content="Back to basics: Dictionary part 4, custom GetHashCode" />
  <meta name="twitter:description" content="" />
  

</head>

<body>
  <div class="navbar-container">
    <nav class="navbar container is-max-desktop" role="navigation" aria-label="main navigation">
      <div class="navbar-brand">

        <a role="button" class="navbar-burger burger" aria-label="menu" aria-expanded="false" data-target="navbarMenu">
          <span aria-hidden="true"></span>
          <span aria-hidden="true"></span>
          <span aria-hidden="true"></span>
        </a>
      </div>
      <div id="navbarMenu" class="navbar-menu has-text-white-ter">

        <div class="navbar-start">
          
          <a class="navbar-item" href="/">About</a>
          
          <a class="navbar-item" href="/posts">Blog</a>
          
          <a class="navbar-item" href="/projects">Projects</a>
          
          <a class="navbar-item" href="/cv.html">Resume</a>
          
        </div>

        <div class="navbar-end pt-2 ml-2">
          <a class="icon is-medium" href="mailto:hello@markvincze.com" target="_blank">
            <i class="fa fa-lg fa-envelope"></i>
          </a>
          <a class="icon is-medium" href="https://bsky.app/profile/markvincze.com" target="_blank">
            <i class="fab fa-lg fa-bluesky"></i>
          </a>
          <a class="icon is-medium" href="https://twitter.com/mrkvincze" target="_blank">
            <i class="fab fa-lg fa-twitter"></i>
          </a>
          <a class="icon is-medium" href="https://www.github.com/markvincze" target="_blank">
            <i class="fab fa-lg fa-github"></i>
          </a>
          <a class="icon is-medium" href="https://www.youtube.com/@markvincze8205" target="_blank">
            <i class="fab fa-lg fa-youtube"></i>
          </a>
          <a class="icon is-medium" href="https://stackoverflow.com/users/974733/mark-vincze" target="_blank">
            <i class="fab fa-lg fa-stack-overflow"></i>
          </a>
          <a class="icon is-medium" href="https://www.linkedin.com/in/markvincze" target="_blank">
            <i class="fab fa-lg fa-linkedin"></i>
          </a>
          <a class="icon is-medium" href="/index.xml" target="_blank">
            <i class="fas fa-lg fa-rss"></i>
          </a>
        </div>
      </div>
    </nav>
  </div>

  <div class="hero-body">
    <div class="container has-text-centered">
      <a href="/">
        <h1 class="title is-2">
          Mark Vincze
        </h1>
      </a>
      <h2 class="subtitle is-5">
        Software Developer
      </h2>
    </div>
  </div>

  

<section class="section">
  <div class="container is-max-desktop">
    <h1 class="title is-1">Back to basics: Dictionary part 4, custom GetHashCode</h1>

    
      


<p class="mb-3 is-vcentered">
  <time class="has-text-grey" datetime="2015-10-25">Oct 25, 2015 &bull;</time>

  
  
  <a class="button is-link is-light is-primary is-small p-2 mr-1 is-uppercase has-text-weight-semibold" style="height: 2em; margin-top: 0.1em" href="https://blog.markvincze.com/tags/c%23/">c#</a>
  
  
  <a class="button is-link is-light is-primary is-small p-2 mr-1 is-uppercase has-text-weight-semibold" style="height: 2em; margin-top: 0.1em" href="https://blog.markvincze.com/tags/.net/">.net</a>
  
  
  <a class="button is-link is-light is-primary is-small p-2 mr-1 is-uppercase has-text-weight-semibold" style="height: 2em; margin-top: 0.1em" href="https://blog.markvincze.com/tags/basics/">basics</a>
  
  
  <a class="button is-link is-light is-primary is-small p-2 mr-1 is-uppercase has-text-weight-semibold" style="height: 2em; margin-top: 0.1em" href="https://blog.markvincze.com/tags/computer-science/">computer science</a>
  

</p>

      <div style="font-style: italic; font-size: 0.9em;">No generative AI was used to write this post.</div>
    

    <article class="content mt-6">
      <p><strong>Posts in this series</strong>:</p>
<ol>
<li><a href="/back-to-basics-dictionary-part-1">Part 1: Hash tables</a></li>
<li><a href="/back-to-basics-dictionary-part-2-net-implementation">Part 2: .NET implementation</a></li>
<li><a href="/back-to-basics-dictionary-part-3-built-in-gethashcode">Part 3: Built-in GetHashCode</a></li>
<li><a href="/back-to-basics-dictionary-part-4-custom-gethashcode">Part 4: Custom GetHashCode</a></li>
</ol>
<h1 id="general-guidelines">General guidelines</h1>
<p>This is the last part in the series about the Dictionary class and the GetHashCode method. In this post we&rsquo;ll take a look at what to look out for when implementing a custom GetHashCode method. In the <a href="/back-to-basics-dictionary-part-3-built-in-gethashcode/">previous post</a> we&rsquo;ve seen how the built-in GetHashCode works.</p>
<p>We create a custom implementation when we want to deviate from the default behavior, namely:</p>
<ul>
<li>In case of a reference type, we don&rsquo;t want to base the hash code on the reference of the object, but rather on its value (by default, the hash code is calculated based on the reference).</li>
<li>In case of a value type, we want to base the hash code on only a subset of its fields (by default, the hash code depends on all of the fields).</li>
</ul>
<p>This post won&rsquo;t be about what algorithm to use when calculating the actual hash value. That&rsquo;s a much deeper topic, and it&rsquo;s not particularly my area of expertise. If you&rsquo;re interested in a guide for that, check out chapter 3.9 of Effective Java, that is a good starting point.</p>
<p>However, here are some general rules of thumb to follow (source: <a href="https://msdn.microsoft.com/en-us/library/system.object.gethashcode(v=vs.110).aspx">Object.GetHashCode</a> documentation on MSDN).</p>
<ul>
<li>Equality of hash keys does not imply the equality of the objects itself. This is logical, because there are much more possible different objects than different hash codes.</li>
<li>However, if two objects are equal (so that obj.Equals(other) returns true), their hash codes should be equal too.</li>
<li>If a class overrides GetHashCode, it should do so with Equals too, and it should work in the way defined in the above two points.</li>
<li>During a single execution of an application, GetHashCode should consistently return the same value for an object every time, if there was no modification in the state of the object. What this means in practice is that we shouldn&rsquo;t make the implementation depend on random values, or the current date or time, etc.</li>
<li>GetHashCode should not throw an exception.</li>
<li>The implementation should be generally inexpensive to execute. Otherwise, it might slow down all the classes depending on it, for instance the HashTable and the Dictionary.<br>
In practice this means that we shouldn&rsquo;t do anything <em>crazy</em> in it, we shouldn&rsquo;t start a background thread, do a DB-query or an HTTP-call. Also, the implementation should be fairly simple in order to execute fast.<br>
<strong>Note</strong>: Sometimes it makes sense to make a hash function complicated, so it&rsquo;s <em>guaranteed</em> that it takes a long time to compute, so that an attacker cannot mass-compute the hashes of many values. Such a function is called a <em>cryptographic</em> hash function, but that shouldn&rsquo;t be implemented with Object.GetHashCode. If you&rsquo;re interested, look up the <a href="https://msdn.microsoft.com/en-us/library/system.security.cryptography.hashalgorithm(v=vs.110).aspx">HashAlgorithm</a> class.</li>
</ul>
<p>These are all requirements on which classes using hash codes can depend on. So if you want to use GetHashCode in your own code, then for example you don&rsquo;t have to handle exceptions, or worry about calling it many times slowing your application down, because every well-behaving .NET class should have a GetHashCode implementation which is fast, and does not throw.</p>
<h1 id="mutability">Mutability</h1>
<p>Even if we adhere to the above points, we can have a different set of problems when mutability comes into the picture.</p>
<p>The root cause of the problem is the same as what we looked at in the previous post when discussing the built-in GetHash-code implementation of value types: we get the hash code by calling GetHashCode, the implementation of which depends on some mutable field of the object.<br>
Then we process that object depending on the code, for instance we put it into a bucket of a hash map.
If we mutate the object so that its GetHashCode method returns a different value, then the state of our program becomes inconsistent. That&rsquo;s what we saw in the previous post, when we weren&rsquo;t able to find our entry in the Dictionary any more.</p>
<p>An easy solution to this problem is to follow the general rule, that no mutable fields should be used in the implementation of GetHashCode. As we&rsquo;ve seen in the previous post, ReSharper warns you about this:

<a href="/images/2015/08/vs-warning.png" data-dimbox="">
  <img src="/images/2015/08/vs-warning.png" alt="Visual Studio warning us about using a mutable field in GetHashCode" 
  style="display:block; margin: auto;" />
</a>

</p>
<h1 id="the-importance-of-equals">The importance of Equals</h1>
<p>As noted above, if we override GetHashCode, we must do so with Equals, in a way that they are &ldquo;consistent&rdquo;, so that if two objects are equal, then they also have the same hash code.<br>
The classes using GetHashCode depend on this requirement, so if we don&rsquo;t adhere to it, then we quickly get into an inconsistent state.</p>
<p>The following example shows a class which has an incorrect implementation.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-csharp" data-lang="csharp"><span style="color:#66d9ef">var</span> testDict = <span style="color:#66d9ef">new</span> Dictionary&lt;WrongClass, <span style="color:#66d9ef">string</span>&gt;();

<span style="color:#66d9ef">var</span> key = <span style="color:#66d9ef">new</span> WrongClass(<span style="color:#e6db74">&#34;key1&#34;</span>);
testDict.Add(key, <span style="color:#e6db74">&#34;content&#34;</span>);

<span style="color:#66d9ef">var</span> contains1 = testDict.ContainsKey(key); <span style="color:#75715e">// Returns true
</span><span style="color:#75715e"></span><span style="color:#66d9ef">var</span> contains2 = testDict.ContainsKey(<span style="color:#66d9ef">new</span> WrongClass(<span style="color:#e6db74">&#34;key1&#34;</span>)); <span style="color:#75715e">// Returns false
</span><span style="color:#75715e"></span>
<span style="color:#66d9ef">var</span> entry1 = testDict[key]; <span style="color:#75715e">// Returns the entry
</span><span style="color:#75715e"></span><span style="color:#66d9ef">var</span> entry2 = testDict[<span style="color:#66d9ef">new</span> WrongClass(<span style="color:#e6db74">&#34;key1&#34;</span>)]; <span style="color:#75715e">// Throws KeyNotFoundException
</span></code></pre></div><h1 id="conclusion">Conclusion</h1>
<p>With this I finish this series of posts about the Dictionary. When using built-in classes of the framework, it&rsquo;s always nice to have at least some understanding of what is going on under the hood. Maybe in the future I&rsquo;ll take a look at another class of the .NET Framework.<br>
And if you&rsquo;re uncertain, you can always take a look at the source code at the <a href="http://referencesource.microsoft.com/">Reference Source</a>.</p>

    </article>

    
    <div id="disqus_thread"></div>
    <script>
      var disqus_config = function () {
        this.page.url = 'https:\/\/blog.markvincze.com\/back-to-basics-dictionary-part-4-custom-gethashcode\/';
        
        this.page.identifier = 'ghost-9';
        
      };
      (function () { 
        var d = document, s = d.createElement('script');
        s.src = 'https://markvinczeblog.disqus.com/embed.js';
        s.setAttribute('data-timestamp', +new Date());
        (d.head || d.body).appendChild(s);
      })();
    </script>
    <noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
  </div>
  

</section>



  <div style="flex: 1"></div>

  <footer class="footer py-6">
    <div class="content has-text-centered">
      <p>
        Â© 2025 <strong>Mark Vincze</strong>. All rights reserved.<br />
        Built with <a href="https://gohugo.io/">Hugo</a> and <a href="https://bulma.io/">Bulma</a>. ðŸ’™
      </p>
    </div>
  </footer>

</body>

</html>
