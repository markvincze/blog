<!DOCTYPE html>
<html>

<head>
  
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-72523215-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag() { dataLayer.push(arguments); }
    gtag('js', new Date());
    gtag('config', 'UA-72523215-1');
  </script>

  <title>How to store state during SpecFlow tests?</title>

  <link rel="stylesheet" href="/styles/styles.css">
  <script defer src="https://use.fontawesome.com/releases/v5.15.1/js/all.js"></script>
  <script defer src="/scripts/scripts.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/cookieconsent@3/build/cookieconsent.min.js" data-cfasync="false"></script>
  <link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/cookieconsent@3/build/cookieconsent.min.css" />
  <link rel="icon" href="/favicon.png" type="image/png" />

  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="description" content="There are different ways to store state during SpecFlow tests, and all of them have benefits and drawbacks." />
  <meta property="og:url" content="https://blog.markvincze.com/how-to-store-state-during-specflow-tests/" />
  <meta property="og:type" content="article" />
  <meta property="og:title" content="How to store state during SpecFlow tests?" />
  <meta property="og:description" content="There are different ways to store state during SpecFlow tests, and all of them have benefits and drawbacks." />
  
  <meta name="twitter:card" content="summary" />
  <meta name="twitter:site" content="@mrkvincze" />
  <meta name="twitter:title" content="How to store state during SpecFlow tests?" />
  <meta name="twitter:description" content="There are different ways to store state during SpecFlow tests, and all of them have benefits and drawbacks." />
  

</head>

<body>
  <div class="navbar-container">
    <nav class="navbar container is-max-desktop" role="navigation" aria-label="main navigation">
      <div class="navbar-brand">

        <a role="button" class="navbar-burger burger" aria-label="menu" aria-expanded="false" data-target="navbarMenu">
          <span aria-hidden="true"></span>
          <span aria-hidden="true"></span>
          <span aria-hidden="true"></span>
        </a>
      </div>
      <div id="navbarMenu" class="navbar-menu has-text-white-ter">

        <div class="navbar-start">
          
          <a class="navbar-item" href="/">About</a>
          
          <a class="navbar-item" href="/posts">Blog</a>
          
          <a class="navbar-item" href="/projects">Projects</a>
          
        </div>

        <div class="navbar-end pt-2 ml-2">
          <a class="icon is-medium" href="https://twitter.com/mrkvincze" target="_blank">
            <i class="fab fa-lg fa-twitter"></i>
          </a>
          <a class="icon is-medium" href="https://www.github.com/markvincze" target="_blank">
            <i class="fab fa-lg fa-github"></i>
          </a>
          <a class="icon is-medium" href="https://stackoverflow.com/users/974733/mark-vincze" target="_blank">
            <i class="fab fa-lg fa-stack-overflow"></i>
          </a>
          <a class="icon is-medium" href="https://www.linkedin.com/in/markvincze" target="_blank">
            <i class="fab fa-lg fa-linkedin"></i>
          </a>
          <a class="icon is-medium" href="/index.xml" target="_blank">
            <i class="fas fa-lg fa-rss"></i>
          </a>
        </div>
      </div>
    </nav>
  </div>

  <div class="hero-body">
    <div class="container has-text-centered">
      <a href="/">
        <h1 class="title is-2">
          Mark Vincze
        </h1>
      </a>
      <h2 class="subtitle is-5">
        Software Developer
      </h2>
    </div>
  </div>

  

<section class="section">
  <div class="container is-max-desktop">
    <h1 class="title is-1">How to store state during SpecFlow tests?</h1>

    
      


<p class="mb-3 is-vcentered">
  <time class="has-text-grey" datetime="2015-06-06">Jun 6, 2015 &bull;</time>

  
  
  <a class="button is-link is-light is-primary is-small p-2 mr-1 is-uppercase has-text-weight-semibold" style="height: 2em; margin-top: 0.1em" href="https://blog.markvincze.com/tags/visual-studio">visual studio</a>
  
  
  <a class="button is-link is-light is-primary is-small p-2 mr-1 is-uppercase has-text-weight-semibold" style="height: 2em; margin-top: 0.1em" href="https://blog.markvincze.com/tags/specflow">specflow</a>
  
  
  <a class="button is-link is-light is-primary is-small p-2 mr-1 is-uppercase has-text-weight-semibold" style="height: 2em; margin-top: 0.1em" href="https://blog.markvincze.com/tags/c">c#</a>
  
  
  <a class="button is-link is-light is-primary is-small p-2 mr-1 is-uppercase has-text-weight-semibold" style="height: 2em; margin-top: 0.1em" href="https://blog.markvincze.com/tags/.net">.net</a>
  

</p>
    

    <article class="content mt-6">
      <h1 id="introduction">Introduction</h1>
<p><a href="http://www.specflow.org/">SpecFlow</a> is an implementation of the <a href="https://github.com/cucumber/cucumber/wiki/Gherkin">Gherkin</a> language for the .NET Framework. SpecFlow is to .NET what <a href="https://cucumber.io/">Cucumber</a> is for the JavaScript ecosystem.
It is a way to write tests in a DSL that is easily readable (and maybe writable) by not just developers, but also the business. A simple example from the Cucumber web site (which is also generated when a new SpecFlow feature is added in Visual Studio) is the following:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-csharp" data-lang="csharp">Feature: Addition

Scenario Outline: Add two numbers
    Given I have entered <span style="color:#ae81ff">50</span> <span style="color:#66d9ef">into</span> the calculator
    And I have entered <span style="color:#ae81ff">70</span> <span style="color:#66d9ef">into</span> the calculator
    When I press <span style="color:#66d9ef">add</span>
    Then the result should be <span style="color:#ae81ff">120</span> <span style="color:#66d9ef">on</span> the screen
</code></pre></div><p>What SpecFlow does is that it generates some C# code based on the Gherkin test descriptions, therefore implementing unit tests which will try to execute the steps in the feature description.
All the steps must have a corresponding method implementing the step in a binding class.
The binding class implementing the above steps could look like this:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-csharp" data-lang="csharp"><span style="color:#a6e22e">[Binding]</span>
<span style="color:#66d9ef">public</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">CalculatorTestSteps</span>
{
    <span style="color:#66d9ef">private</span> <span style="color:#66d9ef">readonly</span> Calculator calculator = <span style="color:#66d9ef">new</span> Calculator();
<span style="color:#a6e22e">
</span><span style="color:#a6e22e">    [Given(@&#34;I have entered (\d+) into the calculator&#34;)]</span>

    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">void</span> GivenIHaveEnteredIntoTheCalculator(<span style="color:#66d9ef">int</span> number)
    {
        <span style="color:#66d9ef">this</span>.calculator.Push(number);
    }
<span style="color:#a6e22e">
</span><span style="color:#a6e22e">    [When(@&#34;I press add&#34;)]</span>
    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">void</span> GivenIPressAdd()
    {
        <span style="color:#66d9ef">this</span>.calculator.Add();
    }
<span style="color:#a6e22e">
</span><span style="color:#a6e22e">    [Then(@&#34;the result should be (\d+) on the screen&#34;)]</span>
    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">void</span> ThenTheResultShouldBeOnTheScreen(<span style="color:#66d9ef">int</span> result)
    {
        Assert.AreEqual(result, <span style="color:#66d9ef">this</span>.calculator.result);
    }
}
</code></pre></div><p>SpecFlow generates a unit test based on the feature definition, which basically instantiates the above class, and executes the instance methods corresponding to the feature steps.
The unit tests themselves can be run with the test runner of our choice (for instance the built-in VS test runner or ReSharper), and assertions can be implemented with the usual Assert mechanism of the test framework (which can be either MSTest or NUnit).</p>
<h1 id="maintaining-state-during-a-test">Maintaining state during a test</h1>
<p>Most of the time we need to store and maintain some kind of state during a test. For instance in the Given step we initialize some input data, in the When step we use that input data to send a request to a service and then save the result, and in the When step we execute assertions on the result.
There are different ways to store data in SpecFlow steps. In the rest of the post I will introduce three different ways to achieve this.</p>
<h2 id="using-a-private-field">Using a private field</h2>
<p>The simplest solution is what I used in the Calculator example. Simply create a field in the binding class, and store data in that field, which can be used in all of the steps. A pseudocode of a test sending a GET HTTP request and verifying the returned status code using this technique looks like this:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-csharp" data-lang="csharp"><span style="color:#a6e22e">[Binding]</span>
<span style="color:#66d9ef">public</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">ServiceTestSteps</span>
{
    <span style="color:#66d9ef">private</span> IRestResponse response;
<span style="color:#a6e22e">
</span><span style="color:#a6e22e">    [When(@&#34;I send the request&#34;)]</span>
    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">void</span> WhenISendTheRequest()
    {
        <span style="color:#66d9ef">this</span>.response = <span style="color:#66d9ef">new</span> RestClient().Execute(<span style="color:#66d9ef">new</span> RestRequest(<span style="color:#e6db74">&#34;http://my-service.com&#34;</span>, Method.GET));
    }
<span style="color:#a6e22e">
</span><span style="color:#a6e22e">    [Then(@&#34;the status code should be OK&#34;)]</span>
    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">void</span> ThenTheStatusCodeShouldBeOK()
    {
        Assert.AreEqual(HttpStatusCode.OK, <span style="color:#66d9ef">this</span>.response.StatusCode);
    }
}
</code></pre></div><p>The above solution is very simple and it requires the least amount of code, but it has one significant drawback: if we implement a feature, which has steps implemented in different binding classes, the state won&rsquo;t be shared among those classes, since the binding class instances won&rsquo;t see the each other during the feature execution.</p>
<h2 id="using-the-scenariocontext">Using the ScenarioContext</h2>
<p><code>ScenarioContext</code> is a static class that has a shared state during the execution of a scenario. It can be freely used as a dictionary, either storing an object of a specific type without a key, or explicitly specifying a string key. The <code>ScenarioContext</code> can be accessed by all the binding classes involved, so they can share the state.<br>
The implementation of the same test using this approach is the following.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-csharp" data-lang="csharp"><span style="color:#a6e22e">[Binding]</span>
<span style="color:#66d9ef">public</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">ServiceTestSteps</span>
{
<span style="color:#a6e22e">    [When(@&#34;I send the request&#34;)]</span>
    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">void</span> WhenISendTheRequest()
    {
        ScenarioContext.Current.Set&lt;IRestResponse&gt;(<span style="color:#66d9ef">new</span> RestClient().Execute(<span style="color:#66d9ef">new</span> RestRequest(<span style="color:#e6db74">&#34;http://my-service.com&#34;</span>, Method.GET)));
    }
<span style="color:#a6e22e">
</span><span style="color:#a6e22e">    [Then(@&#34;the status code should be OK&#34;)]</span>
    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">void</span> ThenTheStatusCodeShouldBeOK(<span style="color:#66d9ef">int</span> result)
    {
        Assert.AreEqual(HttpStatusCode.OK, ScenarioContext.Current.Get&lt;IRestResponse&gt;().StatusCode);
    }
}
</code></pre></div><p>The drawback of using the <code>ScenarioContext</code> is that the contract between the different steps will not be explicit. If we change the data stored in one step we have to update all of the other steps which depend on it, and we won&rsquo;t get any compilation errors if we don&rsquo;t do so.
The situation is even worse if we store multiple instances of the same type and have to use and maintain hard-coded string keys.
The last solution solves this problem, but ??? as usual ??? it requires writing the most amount of code.</p>
<h2 id="injecting-a-context-instance">Injecting a context instance</h2>
<p>The SpecFlow engine supports injecting objects into the instantiated binding classes through their constructor. We just simply have to add constructor parameters to the binding classes, the rest will be taken care of by SpecFlow.<br>
It also makes sure that even if multiple binding classes have a constructor parameter of the same type, only a single instance of the said type will be created during the execution of a feature, so this feature is ideal for sharing state.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-csharp" data-lang="csharp"><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">ServiceTestContext</span>
{
    <span style="color:#66d9ef">public</span> IRestResponse Response { <span style="color:#66d9ef">get</span>; <span style="color:#66d9ef">set</span>; }
}
<span style="color:#a6e22e">
</span><span style="color:#a6e22e">[Binding]</span>
<span style="color:#66d9ef">public</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">ServiceTestSteps</span>
{
    <span style="color:#66d9ef">private</span> <span style="color:#66d9ef">readonly</span> ServiceTestContext context;

    ServiceTestSteps(ServiceTestContext context)
    {
        <span style="color:#66d9ef">this</span>.context = context;
    }
<span style="color:#a6e22e">
</span><span style="color:#a6e22e">    [When(@&#34;I send the request&#34;)]</span>
    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">void</span> WhenISendTheRequest()
    {
        context.Response = <span style="color:#66d9ef">new</span> RestClient().Execute(<span style="color:#66d9ef">new</span> RestRequest(<span style="color:#e6db74">&#34;http://my-service.com&#34;</span>, Method.GET));
    }
<span style="color:#a6e22e">
</span><span style="color:#a6e22e">    [Then(@&#34;the status code should be OK&#34;)]</span>
    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">void</span> ThenTheStatusCodeShouldBeOK()
    {
        Assert.AreEqual(HttpStatusCode.OK, context.Response.StatusCode);
    }
}
</code></pre></div><p>This context instance can be shared simply by adding it to another class as a constructor parameter.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-csharp" data-lang="csharp"><span style="color:#a6e22e">[Binding]</span>
<span style="color:#66d9ef">public</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">FruitTestSteps</span>
{
    <span style="color:#66d9ef">private</span> <span style="color:#66d9ef">readonly</span> ServiceTestContext context;

    ServiceTestSteps(ServiceTestContext context)
    {
        <span style="color:#66d9ef">this</span>.context = context;
    }
<span style="color:#a6e22e">
</span><span style="color:#a6e22e">    [Then(@&#34;the response should contain &#34;&#34;(.*)&#34;&#34;&#34;)]</span>
    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">void</span> ThenTheResponseShouldContain(<span style="color:#66d9ef">string</span> fruit)
    {
        Assert.IsTrue(<span style="color:#66d9ef">this</span>.context.Response.Content.Contains(fruit))
    }
}
</code></pre></div><p>Then we are able to write a feature which uses steps from both of the binding classes:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-csharp" data-lang="csharp">Scenario: Service response should contain pear
	When I send the request
	Then the status code should be OK
	And the response should contain <span style="color:#e6db74">&#34;pear&#34;</span>
</code></pre></div><h2 id="conclusion">Conclusion</h2>
<p>There are multiple ways of storing state in a Specflow feature, all of which have different benefits and drawbacks.
If we only need the state in a single binding class, we can simply store it as a field of that class.
On the other hand if we need to share the state between multiple binding classes, we have two choices: if we&rsquo;re looking for a quick and dirty solution, the current instance of the ScenarioContext can be used as a dictionary, however, if we are willing to invest writing a bit more code to improve maintainability, we can extract the state to be stored to an external context class, which can be injected into all of the binding classes which need to access the shared data.</p>

    </article>

    
    <div id="disqus_thread"></div>
    <script>
      var disqus_config = function () {
        this.page.url = 'https:\/\/blog.markvincze.com\/how-to-store-state-during-specflow-tests\/';
        
        this.page.identifier = 'ghost-4';
        
      };
      (function () { 
        var d = document, s = d.createElement('script');
        s.src = 'https://markvinczeblog.disqus.com/embed.js';
        s.setAttribute('data-timestamp', +new Date());
        (d.head || d.body).appendChild(s);
      })();
    </script>
    <noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
  </div>
  

</section>



  <div style="flex: 1"></div>

  <footer class="footer py-6">
    <div class="content has-text-centered">
      <p>
        © 2020 <strong>Mark Vincze</strong>. All rights reserved.<br />
        Built with <a href="https://gohugo.io/">Hugo</a> and <a href="https://bulma.io/">Bulma</a>. 💙
      </p>
    </div>
  </footer>

</body>

</html>