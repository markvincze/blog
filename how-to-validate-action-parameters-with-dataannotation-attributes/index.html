<!DOCTYPE html>
<html lang="en">

<head>
  
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-72523215-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag() { dataLayer.push(arguments); }
    gtag('js', new Date());
    gtag('config', 'UA-72523215-1');
  </script>

  <title>How to validate action parameters with DataAnnotation attributes?</title>

  <link rel="stylesheet" href="/styles/styles.css">
  <script defer src="https://use.fontawesome.com/releases/v5.15.1/js/all.js"></script>
  <script defer src="/scripts/scripts.js"></script>
  <script defer src="https://cdn.jsdelivr.net/npm/cookieconsent@3/build/cookieconsent.min.js" data-cfasync="false"></script>
  <link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/cookieconsent@3/build/cookieconsent.min.css" />

  <link rel="apple-touch-icon" sizes="180x180" href="apple-touch-icon.png">
  <link rel="icon" type="image/png" sizes="32x32" href="favicon-32x32.png">
  <link rel="icon" type="image/png" sizes="16x16" href="favicon-16x16.png">
  <link rel="manifest" href="site.webmanifest">

  <meta charset="utf-8">

  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="description" content="A simple approach to evaluate DataAnnotation validation attributes not only on model properties, but on the action method parameters as well." />

  <meta property="og:url" content="https://blog.markvincze.com/how-to-validate-action-parameters-with-dataannotation-attributes/" />
  <meta property="og:type" content="article" />
  <meta property="og:title" content="How to validate action parameters with DataAnnotation attributes?" />
  <meta property="og:description" content="A simple approach to evaluate DataAnnotation validation attributes not only on model properties, but on the action method parameters as well." />
  <meta property="og:site_name" content="Mark Vincze" />
  

  <meta name="twitter:card" content="summary" />
  <meta name="twitter:site" content="@mrkvincze" />
  <meta name="twitter:title" content="How to validate action parameters with DataAnnotation attributes?" />
  <meta name="twitter:description" content="A simple approach to evaluate DataAnnotation validation attributes not only on model properties, but on the action method parameters as well." />
  

</head>

<body>
  <div class="navbar-container">
    <nav class="navbar container is-max-desktop" role="navigation" aria-label="main navigation">
      <div class="navbar-brand">

        <a role="button" class="navbar-burger burger" aria-label="menu" aria-expanded="false" data-target="navbarMenu">
          <span aria-hidden="true"></span>
          <span aria-hidden="true"></span>
          <span aria-hidden="true"></span>
        </a>
      </div>
      <div id="navbarMenu" class="navbar-menu has-text-white-ter">

        <div class="navbar-start">
          
          <a class="navbar-item" href="/">About</a>
          
          <a class="navbar-item" href="/posts">Blog</a>
          
          <a class="navbar-item" href="/projects">Projects</a>
          
          <a class="navbar-item" href="/cv.html">Resume</a>
          
        </div>

        <div class="navbar-end pt-2 ml-2">
          <a class="icon is-medium" href="https://twitter.com/mrkvincze" target="_blank">
            <i class="fab fa-lg fa-twitter"></i>
          </a>
          <a class="icon is-medium" href="https://www.github.com/markvincze" target="_blank">
            <i class="fab fa-lg fa-github"></i>
          </a>
          <a class="icon is-medium" href="https://stackoverflow.com/users/974733/mark-vincze" target="_blank">
            <i class="fab fa-lg fa-stack-overflow"></i>
          </a>
          <a class="icon is-medium" href="https://www.linkedin.com/in/markvincze" target="_blank">
            <i class="fab fa-lg fa-linkedin"></i>
          </a>
          <a class="icon is-medium" href="/index.xml" target="_blank">
            <i class="fas fa-lg fa-rss"></i>
          </a>
        </div>
      </div>
    </nav>
  </div>

  <div class="hero-body">
    <div class="container has-text-centered">
      <a href="/">
        <h1 class="title is-2">
          Mark Vincze
        </h1>
      </a>
      <h2 class="subtitle is-5">
        Software Developer
      </h2>
    </div>
  </div>

  

<section class="section">
  <div class="container is-max-desktop">
    <h1 class="title is-1">How to validate action parameters with DataAnnotation attributes?</h1>

    
      


<p class="mb-3 is-vcentered">
  <time class="has-text-grey" datetime="2016-02-28">Feb 28, 2016 &bull;</time>

  
  
  <a class="button is-link is-light is-primary is-small p-2 mr-1 is-uppercase has-text-weight-semibold" style="height: 2em; margin-top: 0.1em" href="https://blog.markvincze.com/tags/asp.net/">asp.net</a>
  
  
  <a class="button is-link is-light is-primary is-small p-2 mr-1 is-uppercase has-text-weight-semibold" style="height: 2em; margin-top: 0.1em" href="https://blog.markvincze.com/tags/c%23/">c#</a>
  
  
  <a class="button is-link is-light is-primary is-small p-2 mr-1 is-uppercase has-text-weight-semibold" style="height: 2em; margin-top: 0.1em" href="https://blog.markvincze.com/tags/.net-core/">.net-core</a>
  
  
  <a class="button is-link is-light is-primary is-small p-2 mr-1 is-uppercase has-text-weight-semibold" style="height: 2em; margin-top: 0.1em" href="https://blog.markvincze.com/tags/asp.net-core/">asp.net-core</a>
  

</p>
    

    <article class="content mt-6">
      <h2 id="model-validation-in-mvc">Model validation in MVC</h2>
<p>In both MVC and Web Api we can use the attributes provided in the <code>System.ComponentModel.DataAnnotations</code> namespace to specify validation rules for our models.</p>
<p>Let&rsquo;s say we have a controller action with the following signature, accepting a single parameter populated from the request body.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-csharp" data-lang="csharp"><span style="color:#66d9ef">public</span> IActionResult Post([FromBody]Product product);
</code></pre></div><p>And we decorated our <code>Product</code> type with the following validation attributes (example taken from the <a href="http://www.asp.net/web-api/overview/formats-and-model-binding/model-validation-in-aspnet-web-api">official ASP.NET documentation</a>).</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-csharp" data-lang="csharp"><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">Product</span>
{
    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">int</span> Id { <span style="color:#66d9ef">get</span>; <span style="color:#66d9ef">set</span>; }
<span style="color:#a6e22e">    [Required]</span>
    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">string</span> Name { <span style="color:#66d9ef">get</span>; <span style="color:#66d9ef">set</span>; }
    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">decimal</span> Price { <span style="color:#66d9ef">get</span>; <span style="color:#66d9ef">set</span>; }
<span style="color:#a6e22e">    [Range(0, 999)]</span>
    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">double</span> Weight { <span style="color:#66d9ef">get</span>; <span style="color:#66d9ef">set</span>; }
}
</code></pre></div><p>When we call our endpoint by posting a product object in the body of our request, the framework is going to evaluate our validation attributes during the model binding process, and save its result (with possibly errors) in the <code>ModelState</code> property of our controller.<br>
So in the implementation of our action we can simply use the <code>ModelState</code> property to check whether the input is valid or not, and we can return its value as our response in case of an error.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-csharp" data-lang="csharp"><span style="color:#66d9ef">public</span> IActionResult Post(Product product)
{
    <span style="color:#66d9ef">if</span> (!ModelState.IsValid)
    {
        <span style="color:#66d9ef">return</span> HttpBadRequest(ModelState);
    }

    <span style="color:#75715e">// Process the product...
</span><span style="color:#75715e"></span>
    <span style="color:#66d9ef">return</span> Ok();
}
</code></pre></div><p>If we post the following Json to our endpoint (note that the required <code>Name</code> property is missing)</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-json" data-lang="json">{ <span style="color:#f92672">&#34;Id&#34;</span>:<span style="color:#ae81ff">4</span>, <span style="color:#f92672">&#34;Price&#34;</span>:<span style="color:#ae81ff">2.99</span>, <span style="color:#f92672">&#34;Weight&#34;</span>:<span style="color:#ae81ff">5</span> }
</code></pre></div><p>we get back an error response containing all the validation errors produced during the model binding.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-json" data-lang="json">{
  <span style="color:#f92672">&#34;name&#34;</span>: [
    <span style="color:#e6db74">&#34;The Name field is required.&#34;</span>
  ]
}
</code></pre></div><h2 id="validation-attributes-on-action-parameters">Validation attributes on action parameters</h2>
<p>There is nothing preventing us from putting validation attributes not on a model property, but on the method parameters of an action. We might want to enforce our callers to post a product object to this endpoint, so it seems logical to add the <code>Required</code> attribute on the method parameter itself.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-csharp" data-lang="csharp"><span style="color:#66d9ef">public</span> IActionResult Post([FromBody][Required]Product product)
</code></pre></div><p>The problem with this approach - which surprised me - is that it simply doesn&rsquo;t work. The framework does not seem to evaluate these attributes at all.</p>
<p>If we call the endpoint with an empty request body, the value of the <code>product</code> argument will be <code>null</code>, but <code>ModelState.IsValid</code> will return true.</p>
<h3 id="solution">Solution</h3>
<p>Luckily, it is not difficult to hook into the MVC pipeline with a custom filter attribute. With the following custom filter attribute we can iterate over all of the action parameters and evaluate all the validation attributes specified for them.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-csharp" data-lang="csharp"><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">ValidateActionParametersAttribute</span> : ActionFilterAttribute
{
    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">override</span> <span style="color:#66d9ef">void</span> OnActionExecuting(ActionExecutingContext context)
    {
        <span style="color:#66d9ef">var</span> descriptor = context.ActionDescriptor <span style="color:#66d9ef">as</span> ControllerActionDescriptor;

        <span style="color:#66d9ef">if</span> (descriptor != <span style="color:#66d9ef">null</span>)
        {
            <span style="color:#66d9ef">var</span> parameters = descriptor.MethodInfo.GetParameters();

            <span style="color:#66d9ef">foreach</span> (<span style="color:#66d9ef">var</span> parameter <span style="color:#66d9ef">in</span> parameters)
            {
                <span style="color:#66d9ef">var</span> argument = context.ActionArguments[parameter.Name];

                EvaluateValidationAttributes(parameter, argument, context.ModelState);
            }
        }

        <span style="color:#66d9ef">base</span>.OnActionExecuting(context);
    }

    <span style="color:#66d9ef">private</span> <span style="color:#66d9ef">void</span> EvaluateValidationAttributes(ParameterInfo parameter, <span style="color:#66d9ef">object</span> argument, ModelStateDictionary modelState)
    {
        <span style="color:#66d9ef">var</span> validationAttributes = parameter.CustomAttributes;

        <span style="color:#66d9ef">foreach</span> (<span style="color:#66d9ef">var</span> attributeData <span style="color:#66d9ef">in</span> validationAttributes)
        {
            <span style="color:#66d9ef">var</span> attributeInstance = CustomAttributeExtensions.GetCustomAttribute(parameter, attributeData.AttributeType);

            <span style="color:#66d9ef">var</span> validationAttribute = attributeInstance <span style="color:#66d9ef">as</span> ValidationAttribute;

            <span style="color:#66d9ef">if</span> (validationAttribute != <span style="color:#66d9ef">null</span>)
            {
                <span style="color:#66d9ef">var</span> isValid = validationAttribute.IsValid(argument);
                <span style="color:#66d9ef">if</span> (!isValid)
                {
                    modelState.AddModelError(parameter.Name, validationAttribute.FormatErrorMessage(parameter.Name));
                }
            }
        }
    }
}
</code></pre></div><p>(Note: this has been implemented using ASP.NET Core 1.0. In ASP.NET 4 the Api might be slightly different, but the same approach should work there as well.)</p>
<p>If we apply this filter to our action</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-csharp" data-lang="csharp"><span style="color:#a6e22e">[ValidateActionParameters]</span>
<span style="color:#66d9ef">public</span> IActionResult Post([FromBody][Required]Product product)
</code></pre></div><p>and we send a POST request with an empty body, we&rsquo;ll get back the expected error response.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-json" data-lang="json">{<span style="color:#f92672">&#34;product&#34;</span>:[<span style="color:#e6db74">&#34;The product field is required.&#34;</span>]}
</code></pre></div><p>This approach will work nicely even if we have more than one action parameters with multiple different attributes, and also works with custom validation attributes implemented by us. The action I wanted to use this with looked like this, where one of the parameters come from the query string, and the other from the body.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-csharp" data-lang="csharp"><span style="color:#a6e22e">[HttpPost(&#34;{categoryId}/products&#34;)]</span>
IActionResult Post([CustomNotEmptyGuid]Guid categoryId, [FromBody][Required]Product product)
</code></pre></div><p>Since the above code iterates over all the parameters and attributes, we&rsquo;ll get a list of all the errors in the response.</p>
<p>I uploaded the source code to this <a href="https://github.com/markvincze/rest-api-helpers/tree/master">Github respository</a>, and pushed the <a href="https://www.nuget.org/packages/RestApiHelpers/">package</a> to NuGet. I plan to extend it with implementation of other cross-cutting concerns useful in a Rest Api in the future.</p>

    </article>

    
    <div id="disqus_thread"></div>
    <script>
      var disqus_config = function () {
        this.page.url = 'https:\/\/blog.markvincze.com\/how-to-validate-action-parameters-with-dataannotation-attributes\/';
        
        this.page.identifier = 'ghost-13';
        
      };
      (function () { 
        var d = document, s = d.createElement('script');
        s.src = 'https://markvinczeblog.disqus.com/embed.js';
        s.setAttribute('data-timestamp', +new Date());
        (d.head || d.body).appendChild(s);
      })();
    </script>
    <noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
  </div>
  

</section>



  <div style="flex: 1"></div>

  <footer class="footer py-6">
    <div class="content has-text-centered">
      <p>
        © 2020 <strong>Mark Vincze</strong>. All rights reserved.<br />
        Built with <a href="https://gohugo.io/">Hugo</a> and <a href="https://bulma.io/">Bulma</a>. 💙
      </p>
    </div>
  </footer>

</body>

</html>