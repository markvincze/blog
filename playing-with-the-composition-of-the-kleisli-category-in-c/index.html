<!DOCTYPE html>
<html lang="en">

<head>
  
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-72523215-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag() { dataLayer.push(arguments); }
    gtag('js', new Date());
    gtag('config', 'UA-72523215-1');
  </script>

  <title>Playing with the composition of the Kleisli category in C#</title>

  <link rel="stylesheet" href="/styles/styles.css">
  <script defer src="https://use.fontawesome.com/releases/v5.15.1/js/all.js"></script>
  <script defer src="/scripts/scripts.js"></script>
  <script defer src="https://cdn.jsdelivr.net/npm/cookieconsent@3/build/cookieconsent.min.js" data-cfasync="false"></script>
  <link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/cookieconsent@3/build/cookieconsent.min.css" />

  <link rel="apple-touch-icon" sizes="180x180" href="apple-touch-icon.png">
  <link rel="icon" type="image/png" sizes="32x32" href="favicon-32x32.png">
  <link rel="icon" type="image/png" sizes="16x16" href="favicon-16x16.png">
  <link rel="manifest" href="site.webmanifest">

  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="description" content="Taking a look at how the composition of the Kleisli category can be implemented in C#, and what are the limitations we have to face in type inference." />
  <meta property="og:url" content="https://blog.markvincze.com/playing-with-the-composition-of-the-kleisli-category-in-c/" />
  <meta property="og:type" content="article" />
  <meta property="og:title" content="Playing with the composition of the Kleisli category in C#" />
  <meta property="og:description" content="Taking a look at how the composition of the Kleisli category can be implemented in C#, and what are the limitations we have to face in type inference." />
  <meta property="og:site_name" content="Mark Vincze" />
  
  <meta name="twitter:card" content="summary" />
  <meta name="twitter:site" content="@mrkvincze" />
  <meta name="twitter:title" content="Playing with the composition of the Kleisli category in C#" />
  <meta name="twitter:description" content="Taking a look at how the composition of the Kleisli category can be implemented in C#, and what are the limitations we have to face in type inference." />
  

</head>

<body>
  <div class="navbar-container">
    <nav class="navbar container is-max-desktop" role="navigation" aria-label="main navigation">
      <div class="navbar-brand">

        <a role="button" class="navbar-burger burger" aria-label="menu" aria-expanded="false" data-target="navbarMenu">
          <span aria-hidden="true"></span>
          <span aria-hidden="true"></span>
          <span aria-hidden="true"></span>
        </a>
      </div>
      <div id="navbarMenu" class="navbar-menu has-text-white-ter">

        <div class="navbar-start">
          
          <a class="navbar-item" href="/">About</a>
          
          <a class="navbar-item" href="/posts">Blog</a>
          
          <a class="navbar-item" href="/projects">Projects</a>
          
          <a class="navbar-item" href="/cv.html">Resume</a>
          
        </div>

        <div class="navbar-end pt-2 ml-2">
          <a class="icon is-medium" href="https://twitter.com/mrkvincze" target="_blank">
            <i class="fab fa-lg fa-twitter"></i>
          </a>
          <a class="icon is-medium" href="https://www.github.com/markvincze" target="_blank">
            <i class="fab fa-lg fa-github"></i>
          </a>
          <a class="icon is-medium" href="https://stackoverflow.com/users/974733/mark-vincze" target="_blank">
            <i class="fab fa-lg fa-stack-overflow"></i>
          </a>
          <a class="icon is-medium" href="https://www.linkedin.com/in/markvincze" target="_blank">
            <i class="fab fa-lg fa-linkedin"></i>
          </a>
          <a class="icon is-medium" href="/index.xml" target="_blank">
            <i class="fas fa-lg fa-rss"></i>
          </a>
        </div>
      </div>
    </nav>
  </div>

  <div class="hero-body">
    <div class="container has-text-centered">
      <a href="/">
        <h1 class="title is-2">
          Mark Vincze
        </h1>
      </a>
      <h2 class="subtitle is-5">
        Software Developer
      </h2>
    </div>
  </div>

  

<section class="section">
  <div class="container is-max-desktop">
    <h1 class="title is-1">Playing with the composition of the Kleisli category in C#</h1>

    
      


<p class="mb-3 is-vcentered">
  <time class="has-text-grey" datetime="2017-04-19">Apr 19, 2017 &bull;</time>

  
  
  <a class="button is-link is-light is-primary is-small p-2 mr-1 is-uppercase has-text-weight-semibold" style="height: 2em; margin-top: 0.1em" href="https://blog.markvincze.com/tags/c%23/">c#</a>
  
  
  <a class="button is-link is-light is-primary is-small p-2 mr-1 is-uppercase has-text-weight-semibold" style="height: 2em; margin-top: 0.1em" href="https://blog.markvincze.com/tags/f%23/">f#</a>
  
  
  <a class="button is-link is-light is-primary is-small p-2 mr-1 is-uppercase has-text-weight-semibold" style="height: 2em; margin-top: 0.1em" href="https://blog.markvincze.com/tags/category-theory/">category-theory</a>
  

</p>
    

    <article class="content mt-6">
      <h1 id="introduction">Introduction</h1>
<p>Recently I learnt about an interesting concept in category theory called a <em>Kleisli category</em>.</p>
<p>Let&rsquo;s look at a concrete example I took from <a href="https://bartoszmilewski.com/2014/12/23/kleisli-categories/">this blog post</a> (in his series about category theory) by Bartosz Milewski.
We would like to extend all of the functions in a library in a way that besides their normal result, they also return an extra string. We&rsquo;ll consider this extra string a sort of log message or &ldquo;comment&rdquo;, which we&rsquo;ll collect as we call various methods.</p>
<p>For example we might have the following original method.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-csharp" data-lang="csharp"><span style="color:#66d9ef">int</span> Increment(<span style="color:#66d9ef">int</span> x)
{
    <span style="color:#66d9ef">return</span> x + <span style="color:#ae81ff">1</span>;
}
</code></pre></div><p>We can extend it the following way to also return a message.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-csharp" data-lang="csharp">(<span style="color:#66d9ef">int</span> result, <span style="color:#66d9ef">string</span> log) Increment(<span style="color:#66d9ef">int</span> x)
{
    <span style="color:#66d9ef">return</span> (x + <span style="color:#ae81ff">1</span>, <span style="color:#e6db74">&#34;Incremented&#34;</span>);
}
</code></pre></div><p>(I wanted to be fancy, so I&rsquo;m using C# 7 tuple literals, but I could also have used a <code>Tuple&lt;int, string&gt;</code> as the return type.)
For the sake of the example I&rsquo;ll implement another method.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-csharp" data-lang="csharp">(<span style="color:#66d9ef">int</span> result, <span style="color:#66d9ef">string</span> log) Double(<span style="color:#66d9ef">int</span> x)
{
    <span style="color:#66d9ef">return</span> (x * <span style="color:#ae81ff">2</span>, <span style="color:#e6db74">&#34;Doubled&#34;</span>);
}
</code></pre></div><p>If we extend the return type of a function with something extra like this, we call it an <em>embellished</em> function. We could imagine many other useful ways to embellish functions. For example we could return what the execution time of the function was, or return a second value containing any errors happened during the call.</p>
<p>It turns out that if we define a way to compose such embellished functions (for example compose <code>Increment</code> and <code>Double</code> so that they are applied after each other), and if we can compose the embellished return values associatively (for example the extra log messages can be concatenated), then our input and output data types, and our functions will form a specific <em>category</em> of category theory called the <em><a href="https://en.wikipedia.org/wiki/Kleisli_category">Kleisli category</a></em>. If you are interested in the details, I recommend the <a href="https://bartoszmilewski.com/2014/12/23/kleisli-categories/">above mentioned post</a>.</p>
<h1 id="composition">Composition</h1>
<p>In this post I&rsquo;m going to focus on the <strong>composition</strong> part, more specifically how such composition can be implemented in C#.</p>
<p>We want to have a methodâ€”let&rsquo;s call it <code>Compose</code>â€”which takes two such embellished functions as input, and returns their composition, that is, a method that executes the two functions after each other, returns the second output, and concatenates the extra log messages.
<em>(Note: I&rsquo;m using the C# terminology pretty loosely here. In C# functions are not first class citizens to the extent they are in some other languages, although we can have various constructs that we can use in a similar way, such as delegates, method groups, anonymous functions or lambda expressions.)</em></p>
<p>It was pretty straightforward to implement a specific composition method for the above scenario. The only tricky part, that needed an extra mental step is that in this method we shouldn&rsquo;t actually <em>call</em> the functions passed as inputs, but we just have to return a function that will call them when executed.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-csharp" data-lang="csharp">Func&lt;<span style="color:#66d9ef">int</span>, (<span style="color:#66d9ef">int</span>, <span style="color:#66d9ef">string</span>)&gt; Compose(Func&lt;<span style="color:#66d9ef">int</span>, (<span style="color:#66d9ef">int</span>, <span style="color:#66d9ef">string</span>)&gt; a, Func&lt;<span style="color:#66d9ef">int</span>, (<span style="color:#66d9ef">int</span>, <span style="color:#66d9ef">string</span>)&gt; b)
{
    <span style="color:#66d9ef">return</span> (<span style="color:#66d9ef">int</span> x) =&gt;
    {
        <span style="color:#66d9ef">var</span> (aResult, aLog) = a(x);
        <span style="color:#66d9ef">var</span> (bResult, bLog) = b(aResult);
        <span style="color:#66d9ef">return</span> (bResult, aLog + bLog);
    };
}
</code></pre></div><p>We can try our composition method in a console application.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-csharp" data-lang="csharp"><span style="color:#66d9ef">var</span> incrementAndDouble = Compose(Increment, Double);

<span style="color:#66d9ef">var</span> (result, log) = incrementAndDouble(<span style="color:#ae81ff">2</span>);

Console.WriteLine(<span style="color:#e6db74">$&#34;Result: {result}, Log: {log}&#34;</span>);
</code></pre></div><p>And in the terminal we&rsquo;ll see that it works:</p>
<pre><code>Result: 6, Log: IncrementedDoubled
</code></pre><h2 id="generic-composition">Generic composition</h2>
<p>The second thing I wanted to achieve is to improve the <code>Compose</code> method by making it generic, so that it can work for all input and output types, not just for integers. This didn&rsquo;t seem to be difficult to achieve, I replaced the concrete types with generic type parameters (except the <code>string</code>, with which the return type is embellished).</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-csharp" data-lang="csharp">Func&lt;A, (C, <span style="color:#66d9ef">string</span>)&gt; Compose&lt;A, B, C&gt;(Func&lt;A, (B, <span style="color:#66d9ef">string</span>)&gt; a, Func&lt;B, (C, <span style="color:#66d9ef">string</span>)&gt; b)
{
    <span style="color:#66d9ef">return</span> (A x) =&gt;
    {
        <span style="color:#66d9ef">var</span> (aResult, aLog) = a(x);
        <span style="color:#66d9ef">var</span> (bResult, bLog) = b(aResult);
        <span style="color:#66d9ef">return</span> (bResult, aLog + bLog);
    };
}
</code></pre></div><p>The configuration of the type parameters nicely correspond to function composition in a mathematical sense, since if we have a function <code>f :: a -&gt; b</code> and <code>g :: b -&gt; c</code>, then the type of their composition will be <code>g âˆ˜ f :: a -&gt; c</code>. Notice that although we use integers both as our input and output, in the generic <code>Compose</code> we still have different type arguments for the parameters and the return values, so it also supports functions that have different input and output types.</p>
<p>I was really happy with this implementation, the building blocks of C# seemed to fall nicely in place. Unfortunately when I tried to use this generic version of <code>Compose</code> with the same call:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-csharp" data-lang="csharp"><span style="color:#66d9ef">var</span> incrementAndDouble = Compose(Increment, Double);
</code></pre></div><p>I received the following build error.</p>
<blockquote>
<p><code>Error CS0411: The type arguments for method 'Program.Compose&lt;A, B, C&gt;(Func&lt;A, (B, string)&gt;, Func&lt;B, (C, string)&gt;)' cannot be inferred from the usage. Try specifying the type arguments explicitly.</code></p>
</blockquote>
<p>I was surprised by this error message, and couldn&rsquo;t immediately figure out its reason. Since in the two methods <code>Increment</code> and <code>Double</code> the parameter and return types are explicitly specified, I thought the compiler would be able to <em>infer</em> the proper values for the type arguments.</p>
<p>I found the reason in the answer to <a href="http://stackoverflow.com/questions/7400550/c-sharp-infer-generic-type-based-on-passing-a-delegate">this SO question</a>: The C# spec states that type inference based on the output type only works if the types are explicitly specified, <em>or</em> if we pass in an anonymous function. The C# constructs we&rsquo;re trying to pass in to <code>Compose</code> are <em>method groups</em>, and the spec does not require the type inference to work for them. (This would not be impossible to do, but it would probably not worth the effort by the compiler, and it could cause more problems, as stated by Eric Lippert in <a href="http://stackoverflow.com/questions/6229131/why-cant-c-sharp-infer-type-from-this-seemingly-simple-obvious-case#comment7312385_6231921">this comment</a>. One of the reasons why this is problematic, is that a method group might have more than one corresponding method underneath because of method overloading, in which case the type inference wouldn&rsquo;t necessarily be unambiguous.)</p>
<p>The way to work around this is to help the compiler, and somehow tell it the actual types of our methods.
We can either explicitly specify the type arguments:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-csharp" data-lang="csharp"><span style="color:#66d9ef">var</span> incrementAndDouble = Compose&lt;<span style="color:#66d9ef">int</span>, <span style="color:#66d9ef">int</span>, <span style="color:#66d9ef">int</span>&gt;(Increment, Double);
</code></pre></div><p>Orâ€”as the spec suggestsâ€”pass in the methods as anonymous functions instead of method groups:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-csharp" data-lang="csharp"><span style="color:#66d9ef">var</span> incrementAndDouble = Compose((<span style="color:#66d9ef">int</span> x) =&gt; Increment(x), (<span style="color:#66d9ef">int</span> x) =&gt; Double(x));
</code></pre></div><p>I&rsquo;m not particularly happy about these workarounds, but so far I couldn&rsquo;t find an easier way to do this in C#.</p>
<p>I&rsquo;m not sure if I&rsquo;ll ever use this approach in a real project, but I found this example interesting enough to share, especially regarding the limitations of the C# type inference algorithm.</p>
<h1 id="composition-in-f35">Composition in F#</h1>
<p>Just to see what the same thing would look like in a language where functions are first-class citizens (and where we don&rsquo;t have function overloading), here is the implementation of the same two functions and the generic composition in F#.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-fsharp" data-lang="fsharp"><span style="color:#66d9ef">let</span> increment x <span style="color:#f92672">=</span> <span style="color:#f92672">(</span>x <span style="color:#f92672">+</span> 1<span style="color:#f92672">,</span> <span style="color:#e6db74">&#34;Incremented&#34;</span><span style="color:#f92672">)</span>

<span style="color:#66d9ef">let</span> double x <span style="color:#f92672">=</span> <span style="color:#f92672">(</span>x <span style="color:#f92672">*</span> 2<span style="color:#f92672">,</span> <span style="color:#e6db74">&#34;Doubled&#34;</span><span style="color:#f92672">)</span>

<span style="color:#66d9ef">let</span> compose a b <span style="color:#f92672">=</span>
    <span style="color:#66d9ef">fun</span> x <span style="color:#f92672">-&gt;</span>
        <span style="color:#66d9ef">let</span> <span style="color:#f92672">(</span>ares<span style="color:#f92672">,</span> alog<span style="color:#f92672">)</span> <span style="color:#f92672">=</span> a x
        <span style="color:#66d9ef">let</span> <span style="color:#f92672">(</span>bres<span style="color:#f92672">,</span> blog<span style="color:#f92672">)</span> <span style="color:#f92672">=</span> b ares
        <span style="color:#f92672">(</span>bres<span style="color:#f92672">,</span> alog <span style="color:#f92672">+</span> blog<span style="color:#f92672">)</span>

<span style="color:#66d9ef">let</span> incrementAndDouble <span style="color:#f92672">=</span> compose increment <span style="color:#66d9ef">double</span>

<span style="color:#66d9ef">let</span> <span style="color:#f92672">(</span>result<span style="color:#f92672">,</span> log<span style="color:#f92672">)</span> <span style="color:#f92672">=</span> incrementAndDouble 2

printfn <span style="color:#e6db74">&#34;Result: %i, Log: %s&#34;</span> result log
</code></pre></div><p>I really like the clarity of the of this code, and especially that through the powerful type inference capabilities of the F# compiler we get both strict strong typing and genericity without explicitly specifying any type signature.</p>
<p>The automatically inferred type signature of the <code>compose</code> function is the following (where <code>a * b</code> means a tuple of <code>a</code> and <code>b</code>):</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-fsharp" data-lang="fsharp"><span style="color:#66d9ef">val</span> compose <span style="color:#f92672">:</span> a<span style="color:#f92672">:(</span><span style="color:#66d9ef">&#39;</span>a <span style="color:#f92672">-&gt;</span> <span style="color:#66d9ef">&#39;</span>b <span style="color:#f92672">*</span> <span style="color:#66d9ef">string</span><span style="color:#f92672">)</span> <span style="color:#f92672">-&gt;</span> b<span style="color:#f92672">:(</span><span style="color:#66d9ef">&#39;</span>b <span style="color:#f92672">-&gt;</span> <span style="color:#66d9ef">&#39;</span>c <span style="color:#f92672">*</span> <span style="color:#66d9ef">string</span><span style="color:#f92672">)</span> <span style="color:#f92672">-&gt;</span> x<span style="color:#f92672">:</span><span style="color:#66d9ef">&#39;</span>a <span style="color:#f92672">-&gt;</span> <span style="color:#66d9ef">&#39;</span>c <span style="color:#f92672">*</span> <span style="color:#66d9ef">string</span>
</code></pre></div><p>Which nicely resonates with the generic type signature we had to specify in the C# implementation.</p>
<p>I hope you found this post interesting, andâ€”especially since I&rsquo;m still in the very beginning of learning about category theoryâ€”any feedback and suggestion is welcome.
I&rsquo;ll try to write some more posts like this as I continue experimenting with concepts of category theory in C# and F#.</p>

    </article>

    
    <div id="disqus_thread"></div>
    <script>
      var disqus_config = function () {
        this.page.url = 'https:\/\/blog.markvincze.com\/playing-with-the-composition-of-the-kleisli-category-in-c\/';
        
        this.page.identifier = 'ghost-36';
        
      };
      (function () { 
        var d = document, s = d.createElement('script');
        s.src = 'https://markvinczeblog.disqus.com/embed.js';
        s.setAttribute('data-timestamp', +new Date());
        (d.head || d.body).appendChild(s);
      })();
    </script>
    <noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
  </div>
  

</section>



  <div style="flex: 1"></div>

  <footer class="footer py-6">
    <div class="content has-text-centered">
      <p>
        Â© 2020 <strong>Mark Vincze</strong>. All rights reserved.<br />
        Built with <a href="https://gohugo.io/">Hugo</a> and <a href="https://bulma.io/">Bulma</a>. ðŸ’™
      </p>
    </div>
  </footer>

</body>

</html>